<%= render "doctors/sub_bar", doctor: @doctor%>


<main class="group">
  <div class="side-content">
    <div class="title">
      <h2>Appointment Types</h2>
    </div>
  </div>

  <div class="sub-content">

    <form class="form" action="<%=  %>" method="POST">
      <h3>New Appointment Type:</h3>

      <%= auth_token %>

      <div class="input">
        <label for="name">Name:</label>
        <input
          id="name"
          type="text"
          name="apptointment_type[name]"
          value="">
      </div>

      <div class="radio-group group">
        <p>Is this a recurring visit?:</p>
        <div class="radio-input">
          <label for="recurrence-yes">Yes</label>
          <input
            id="recurrence-yes"
            type="radio"
            name="appointment_type[name]"
            value="true">
        </div>

        <div class="radio-input">
          <label for="recurrence-no">No</label>
          <input
            id="recurrence-no"
            type="radio"
            name="appointment_type[name]"
            value="false">
        </div>
      </div>

      <div class="input">
        <label for="frequency">Frequency (recommended every x days):</label>
        <input
          id="frequency"
          type="number"
          name="apptointment_type[occurence_frequency]"
          step="1"
          pattern="\d+"
          value="">
      </div>

      <div class="input">
      <label for="doctor">Doctor:</label>

        <select id="doctor" name="appointment[doctor]" data-placeholder="Select Diagnoses..">
          <option value="">Dr. <%=  %></option>
        </select>
      </div>



      <select id="diagnoses-select" multiple style="width: 70%"><option></option></select>

      <div class="submit">
        <input type="submit" value="Add Appointment Type">
      </div>
    </form>
  </div>
</main>

<% content_for :js do %>
  <script type="text/javascript">
    $(document).ready(function() {
      $('select#diagnoses-select').select2({
        placeholder: "Select Diagnoses"
      });

      var $el = $('input.select2-input')
      $el.on('input', function(event) {
        // console.log(event);
        // alert((event.currentTarget.value.length > 2));
        var url = "/search/diagnoses?query=" + event.currentTarget.value;
        if (event.currentTarget.value.length > 2) {
          $.ajax(url, {
            success: function(data, b, resp) {

              // clears out initial selection text
              $('.select2-chosen').text("");
              var html = "";
              var new_options = "";

              data.forEach(function(elem) {
                html += ("<option value='" + elem.code + "'>" + elem.description +"</option>");
                new_options += "<li class='select2-results-dept-0 select2-result select2-result-selectable'><div class='select2-result-label'><span class='select2-match'></span>" + elem.description + "</div></li>"
              });

              var $options = $('select#diagnoses-select')
              var $select_options = $('.select2-results')

              $select_options.html(new_options);
              $options.html(html);
            },
            error: function() {
              console.log("Error Searching for Diagnosis!")
            }
          });
        }

      });

      $('.select2-results').on('click', function(event) {
        $('.select2-chosen').html($(event.currentTarget.firstChild.firstChild).text());
        $('#select2-input').removeClass('select2-focused');
        $('#select2-drop').removeAttr('style');
        $('#select2-drop').removeAttr('id');
        $('#select2-drop').attr('style', "display: none; left: 448px; width: 176px; top: 644px; bottom: auto;");
        $('#select2-drop-mask').removeAttr('style');
        $('#select2-drop-mask').attr('style', 'display: none;');
        // $('#select2-drop').addClass('display-none');
        // $('#select2-drop-mask').addClass('display-none');
        $('#s2id_autogen1').removeAttr('disabled');
        $('.select2-container').removeClass('select2-dropdown-open');

      });


      $('.select2-input').keyup(function(event){
        if(event.keyCode == 13) {
          $input = $('.select2-search > input');

          $('.select2-chosen').text($('.select2-search > input').val());
          $('select#diagnoses-select').html("<option value='" + $input.val() + "'></option>");

          $('#select2-input').removeClass('select2-focused');
          $('#select2-drop').removeAttr('style');
          $('#select2-drop').removeAttr('id');
          $('#select2-drop').attr('style', "display: none; left: 448px; width: 176px; top: 644px; bottom: auto;");
          $('#select2-drop-mask').removeAttr('style');
          $('#select2-drop-mask').attr('style', 'display: none;');
          $('#s2id_autogen1').removeAttr('disabled');
          $('.select2-container').removeClass('select2-dropdown-open');
        }

      });


    });


  </script>
<% end %>