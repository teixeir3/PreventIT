<% form_url = (patient_medication.persisted?) ? user_medication_url(user, patient_medication) : user_medications_url(user) %>

<form class="form" action="<%= form_url %>" method="POST">
	
  <h3><%= (patient_medication.persisted?) ? 'Edit' : 'New' %> Medication:</h3>
  
  <%= auth_token %>
  <%= "<input type='hidden' name='_method' value='PUT'>".html_safe if patient_medication.persisted? %>
  
  
  
  <div class="input">
    <label for="meciation-select">Medication Name:</label>
    <input id="medication-select" type="hidden" name="medication[name]" style="width: 275px;" value="<%= patient_medication.medication.name if patient_medication.medication_id %>">
  </div>
  
 <div class="input">
   <label for="full-name-select">Exact Match:</label>
   <!-- <input id="full-name-select" type="hidden" name="medication[full_name]" style="width: 275px;" value="<%= patient_medication.medication.name if patient_medication.medication_id %>"> -->
   <select
     id="full-name-select"
     name="medication[full_name]]"
     class="hidden">
     <option></option>
     <% if patient_medication.medication_id %>
       <option <%= "selected" if patient_medication.num_type == "tablets" %> value="mg">tablets</option>
     <% end %>
   </select>
 </div>
  
  <div class="input">
    <label for="num_taken">Amount you take in one dose (tablets, puffs, injections..):</label>
    <input
      id="num_taken"
      type="number"
      name="patient_medication[num_taken]"
      value="<%= patient_medication.num_taken if patient_medication.persisted? %>">
  </div>
  
  <label for="schedule">Schedule:</label>
  <div class="input" id="schedule">  
    <label for="frequency-select">Frequency:</label>
    <input
      id="frequency-select"
      name="patient_medication[frequency]"
      type="number"
      value="<%= patient_medication.frequency if patient_medication.persisted? %>">
    </select>
    
    <label for="schedule-select">Time Period:</label>
    <select
      id="time-period-select"
      name="patient_medication[time_period]">
      <option></option>
      <option <%= "selected" if patient_medication.schedule == "qd" %>day</option>
      <option <%= "selected" if patient_medication.schedule == "bid" %>week</option>
      <option <%= "selected" if patient_medication.schedule == "tid" %>month</option>
      <option <%= "selected" if patient_medication.schedule == "qid" %>year</option>
    </select>    
  </div>
  
  <div class="input">
    <label for="count"><%= (patient_medication.persisted?) ? "Quantity Left" : "Starting Quantity" %>:</label>
    <input
      id="count"
      type="number"
      name="patient_medication[count]"
      value="<%= patient_medication.count if patient_medication.persisted? %>">
  </div>
  
   <div class="input">
    <label for="diagnosis-select">Diagnosis:</label>
    <select id="diagnosis-select" name="patient_medication[pt_diagnosis_id]" style="width: 275px">
      <option></option>
      <% patient_diagnoses.each do |patient_diagnosis| %>
      <option class="unique-choice" value="<%= patient_diagnosis.id %>" <%= "selected" if patient_medication.patient_diagnosis && patient_medication.pt_diagnosis_id == patient_diagnosis.id %>><%= patient_diagnosis.diagnosis.description %></option>
      <% end %>
    </select>
  </div>


  <div class="input">
    <label for="date">Start Date:</label>
    <input
      id="date"
      type="date"
      name="patient_medication[start_date]"
      value="<%= patient_medication.start_date.strftime("%Y-%m-%d") if patient_medication.persisted? && patient_medication.start_date %>">
  </div>
  
  <div class="input">
    <label for="refills">Refills:</label>
    <input
      id="refills"
      type="number"
      name="patient_medication[refills]"
      value="<%= patient_medication.refills if patient_medication.persisted? %>">
  </div>

  <div class="input">
    <label for="note">Note:</label>
    <textarea
      id="note"
      name="patient_medication[note]"><%= patient_medication.note if patient_medication.persisted? %></textarea>
  </div>

  <div class="submit long-submit">
    <input type="submit" value="<%= patient_medication.persisted? ? 'Edit' : 'Add' %> Medication">
  </div>
</form>

<% content_for :js do %>
  <script type="text/javascript">
    $(document).ready(function() {
      $('#medication-select').select2({
        placeholder: "Enter a name..",
        minimumInputLength: 2,
        formatSelection: function(data) {
          return data.text;
        },
        ajax: {
          url: '<%= medications_search_url %>',
          dataType: 'json',
          data: function (term, page) {
            return {
              query: term
            };
          },
          results: function(data, page) {
            var results = [];
            $.each(data, function(index, item){
              results.push({id: item, text: item});
            });
            return {results: results};
          }
        },
        initSelection : function (element, callback) { 
          var name = $("#medication-select").val();
          var data = {id: name, text: name};
          callback(data); 
        }
        
      });
      

      $('#medication-select').on('change', function(event) {
        var url = "/search/full_medications?query=" + event.currentTarget.value;
        var $fullName = $('#full-name-select');
        var placeHolder;
        
        $.ajax(url, {
          success: function(data) {
            var html = "<option></option>";
        
            // if (data.length > 0) {
//               console.log("1");
//               placeHolder = "Pick one..";
//             } else {
//               console.log("0");
//               placeHolder = "No matches found";
//               console.log(placeHolder);
//             }
            
            $.each(data, function(i, el) {
              html += ("<option class='unique-choice' value='" + el.name + "'>" + el.name +"</option>");
            });
            
            $fullName.html(html);
          },
          error: function() {
            console.log("Error in full_medication_search!");
          }
        });
        
        $fullName.select2({
          placeholder: "Pick one"
        });
      });
      
      $('#diagnosis-select').select2({
        placeholder: "Select Diagnoses",
        dropdownAutoWidth: true
      });
      
      $('#time-period-select').select2({
        placeholder: "How often you take this medicine.."
      });

      // var ensureUnique = function(name) {
//         var isUniq = true;
// 
//         $('.unique-choice').each(function(i, el) {
//           if (el.text === name) {
//             isUniq = false;
//           };
//         })
// 
//         return isUniq;
//       };
// 
//       var $el = $('input.select2-input')
//       $el.on('input', function(event) {
//         // console.log(event);
//         // alert((event.currentTarget.value.length > 2));
//         
//         
//         var $el = $('input.select2-input')
//         // var $inputs = $el.parent().parent()
// //         $inputs.each(function(i, el) { if (i == 1) {console.log($(el).attr('id')); } });
//         var url = "/search/medications?query=" + event.currentTarget.value;
//         if (event.currentTarget.value.length > 1) {
//           $.ajax(url, {
//             success: function(data, b, resp) {
//               console.log(data);
//               // clears out initial selection text
//               $('.select2-chosen').text("");
//               var html = "";
//               var new_options = "";
//               var new_data = false;
//               data.forEach(function(name) {
//                 if (ensureUnique(name)) {
//                   new_data = true;
//                   html += ("<option class='unique-choice' value='" + name + "'>" + name +"</option>");
//                 }
//                 // new_options += "<li class='select2-results-dept-0 select2-result select2-result-selectable'><div class='select2-result-label'><span class='select2-match'></span>" + name + "</div></li>"
//               });
// 
//               // console.log(html);
//               var $options = $('select#medication-select')
//               var $select_options = $('.select2-results')
//               $options.prepend(html);
//               // if (new_data) {
//  //                $select_options.html(new_options);
//  //              }
//             },
//             error: function() {
//               console.log("Error Searching for Medication!")
//             }
//           });
//         }
// 
//       });
// 
//       $('.select2-results').on('click', function(event) {
//         var targetData = $(event.currentTarget.firstChild.firstChild).text();
//         $('.select2-chosen').html(targetData);
//         $('#select2-input').removeClass('select2-focused');
//         $('#select2-drop').removeAttr('style');
//         $('#select2-drop').removeAttr('id');
//         $('#select2-drop').attr('style', "display: none; left: 448px; width: 176px; top: 644px; bottom: auto;");
//         $('#select2-drop-mask').removeAttr('style');
//         $('#select2-drop-mask').attr('style', 'display: none;');
//         // $('#select2-drop').addClass('display-none');
//         // $('#select2-drop-mask').addClass('display-none');
//         $('#s2id_autogen1').removeAttr('disabled');
//         $('.select2-container').removeClass('select2-dropdown-open');
//         $("select2-default").removeClass("select2-default");
// 
//       });
// 
// 
//       $('.select2-input').keyup(function(event){
//         if(event.keyCode == 13) {
//           $input = $('.select2-search > input');
// 
//           $('.select2-chosen').text($('.select2-search > input').val());
//           $('select#diagnoses-select').html("<option value='" + $input.val() + "'></option>");
// 
//           $('#select2-input').removeClass('select2-focused');
//           $('#select2-drop').removeAttr('style');
//           $('#select2-drop').removeAttr('id');
//           $('#select2-drop').attr('style', "display: none; left: 448px; width: 176px; top: 644px; bottom: auto;");
//           $('#select2-drop-mask').removeAttr('style');
//           $('#select2-drop-mask').attr('style', 'display: none;');
//           $('#s2id_autogen1').removeAttr('disabled');
//           $('.select2-container').removeClass('select2-dropdown-open');
//         }
// 
//       });

    });


  </script>
<% end %>
